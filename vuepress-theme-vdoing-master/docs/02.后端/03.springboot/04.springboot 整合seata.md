---
title: springboot 整合seata
date: 2022-11-14 15:34:11
permalink: /pages/23a575/
categories:
  - 后端
  - springboot
tags:
  - 
author: 
  name: ~chao
---
参考文章：[https://www.cnblogs.com/yhc-910/p/16735445.html](https://www.cnblogs.com/yhc-910/p/16735445.html)<br />（完全copy）<br />**一、前言**<br />Seata出现前，大部分公司使用的都是TCC或者MQ（RocketMq）等来解决分布式事务的问题，TCC代码编写复杂，每个业务均需要实现三个入口，侵入性强，RocketMQ保证的是最终一致性。<br />**二、环境准备**<br />**1、nacos：（这里采用最新版本2.1.1）**<br />下载地址：https://github.com/alibaba/nacos/releases<br />官方文档：https://nacos.io/zh-cn/docs/what-is-nacos.html

**2、seata：（这里采用最新版本1.5.2）**<br />下载地址：https://github.com/seata/seata/releases<br />官方文档：http://seata.io/zh-cn/docs/overview/what-is-seata.html

**3、其它**：<br />redis、maven、mysql等（自行安装）<br />**三、项目搭建（这里仅作本地测试，均采用单机模式）**<br />**1、mysql **自行下载、安装，创建数据库seata、nacos、seata-user、seata-order（后面两个是接入seata的微服务的数据库）<br />**2、nacos**

①解压压缩包，进入nacos目录<br />②进入conf目录，拷贝nacos-mysql.sql到数据库nacos初始化<br />③打开application.properties，找到如下配置，放开注释，修改为本地连接<br />![](https://cdn.nlark.com/yuque/0/2022/gif/28072111/1666083448566-4763009f-af20-4d7e-8de2-06ca615f7f1c.gif#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u7f477b4b&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=20&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u4dfb739c-a635-4424-b4b6-c3998127bb4&title=)<br />### If use MySQL as datasource: spring.datasource.platform=mysql ### Count of DB: db.num=1 ### Connect URL of DB: db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useUnicode=true&useSSL=false&serverTimezone=UTC db.user.0=nacos db.password.0=nacos<br />![](https://cdn.nlark.com/yuque/0/2022/gif/28072111/1666083448481-9eeed5cd-a1a6-47ff-a5cf-d51cbd526f90.gif#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u197e4405&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=20&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u47290aca-53bb-4f9a-8c0d-95cd59b218b&title=)<br />④进入bin目录，执行cmd命令，" .\startup.cmd -m standalone"，观察到如下日志，无报错，即启动成功<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/28072111/1666083448709-02840faa-9295-496c-9e1a-632ce0aeb3a4.png#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=ufcd3e641&margin=%5Bobject%20Object%5D&name=image.png&originHeight=246&originWidth=884&originalType=url&ratio=1&rotation=0&showTitle=false&size=14545&status=done&style=none&taskId=ufe496f28-4bf2-4f0a-982c-890c885f1d0&title=)<br />⑤上图标出的即为nacos管理界面的地址，账号密码均为nacos，登录成功<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/28072111/1666083448790-3a7b75a3-8e97-49d0-95f1-481d48711cc9.png#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u27699327&margin=%5Bobject%20Object%5D&name=image.png&originHeight=490&originWidth=1024&originalType=url&ratio=1&rotation=0&showTitle=false&size=37971&status=done&style=none&taskId=u715033d5-65d3-4f67-9eff-db020a1074c&title=)<br />⑥新建命令空间，我这里加的"yhc"，大家可以自定义，不过后面seata和server的配置需要对应上，后文也会提到。<br />⑦新建配置"seata.yml"，这个配置可以从seata官网demo中找到，注意只用修改db连接即可。<br />![](https://cdn.nlark.com/yuque/0/2022/gif/28072111/1666083448573-d7f2e16b-fed2-46c2-b712-fec16c40437c.gif#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u37f168bc&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=20&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u8bf2b68e-fc45-478f-9594-ac2a5ea55f9&title=)<br />metrics:   enabled: false   exporterList: prometheus   exporterPrometheusPort: 9898   registryType: compact server:   maxCommitRetryTimeout: -1   maxRollbackRetryTimeout: -1   recovery:     asynCommittingRetryPeriod: 1000     committingRetryPeriod: 1000     rollbackingRetryPeriod: 1000     timeoutRetryPeriod: 1000   rollbackRetryTimeoutUnlockEnable: false   undo:     logDeletePeriod: 86400000     logSaveDays: 7 store:   db:     branchTable: branch_table     datasource: druid     dbType: mysql     driverClassName: com.mysql.cj.jdbc.Driver     globalTable: global_table     lockTable: lock_table     maxConn: 30     maxWait: 5000     minConn: 5     password: root     queryLimit: 100     url: jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&rewriteBatchedStatements=true&useSSL=false     user: root   mode: db transport:   compressor: none   serialization: seata<br />![](https://cdn.nlark.com/yuque/0/2022/gif/28072111/1666083449060-16d57822-5118-4a2d-901f-e4cf5481ccc7.gif#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=uaa4b3a24&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=20&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u726382db-0aa8-4580-af97-af025e8b6b1&title=)<br />**3、seata**<br />①解压压缩包，进入seata目录<br />②进入/script/server/db目录，拷贝mysql.sql到数据库seata初始化<br />③进入/conf目录，修改application.yml配置文件，配置中心和注册中心改为nacos<br />![](https://cdn.nlark.com/yuque/0/2022/gif/28072111/1666083449103-aaed2ff8-72d8-4341-baad-e736750ecfc1.gif#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=ueebee8cd&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=20&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u0c02bcff-8c87-469d-819f-274efc2a9d8&title=)<br />seata:   config:     # support: nacos, consul, apollo, zk, etcd3     type: nacos     nacos:       server-addr: localhost:8848       namespace: c23f9030-953e-46bb-8c6e-0bf4a8227a8c       group: yhc       username: nacos       password: nacos       data-id: seata.yml   registry:     # support: nacos, eureka, redis, zk, consul, etcd3, sofa     type: nacos     nacos:       application: seata-server       server-addr: localhost:8848       namespace: c23f9030-953e-46bb-8c6e-0bf4a8227a8c       group: yhc       username: nacos       password: nacos<br />![](https://cdn.nlark.com/yuque/0/2022/gif/28072111/1666083449121-5dbfe440-9525-4245-8549-6a715d5f2206.gif#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=ubd4fb8ce&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=20&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u8bbf1ad9-4a18-4a3f-8049-baa2156fdd1&title=)<br />④进入/bin目录，双击执行seata-server.bat启动<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/28072111/1666083449454-5a0c9aaf-8da5-4970-944f-caea26cdeb4f.png#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=uc268dea2&margin=%5Bobject%20Object%5D&name=image.png&originHeight=282&originWidth=982&originalType=url&ratio=1&rotation=0&showTitle=false&size=50010&status=done&style=none&taskId=u2b99d8f5-e55c-433b-89f4-971cdba5aa7&title=)<br />⑤打开nacos列表，观察seata服务注册成功<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/28072111/1666083449573-83ca9fef-ea06-4385-8bcb-b6d63d27a2e6.png#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=uc5dc4744&margin=%5Bobject%20Object%5D&name=image.png&originHeight=333&originWidth=831&originalType=url&ratio=1&rotation=0&showTitle=false&size=27046&status=done&style=none&taskId=uf3efafd8-41a5-4462-a36f-b1bc592ea0e&title=)<br />**4、服务接入**<br />①引入依赖<br />        <dependency>             <groupId>io.seata</groupId>             <artifactId>seata-spring-boot-starter</artifactId>             <version>1.5.2</version>         </dependency>    <br />②添加seata配置（注意替换nacos配置）<br />![](https://cdn.nlark.com/yuque/0/2022/gif/28072111/1666083449882-ea87750d-bd7c-4092-b296-34fb2694116f.gif#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u85373a21&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=20&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ud884a1df-524c-410d-95c1-9ff8030c19f&title=)<br />seata:   enabled: true   # Seata 应用编号，默认为 ${spring.application.name}   application-id: ${spring.application.name}   # Seata 事务组编号，用于 TC 集群名   tx-service-group: ${spring.application.name}-group   # 关闭自动代理   enable-auto-data-source-proxy: true   # 服务配置项   service:     # 虚拟组和分组的映射     vgroup-mapping:       seata-user-group: default #  config: #    # support: nacos, consul, apollo, zk, etcd3 #    type: nacos #    nacos: #      server-addr: localhost:8848 #      namespace: c23f9030-953e-46bb-8c6e-0bf4a8227a8c #      group: yhc #      username: nacos #      password: nacos   registry:     # support: nacos, eureka, redis, zk, consul, etcd3, sofa     type: nacos     nacos:       application: seata-server       server-addr: 127.0.0.1:8848       namespace: 1238c7de-5821-452d-8586-639ccca55768       group: yhc #      username: nacos #      password: nacos #      cluster: default<br />![](https://cdn.nlark.com/yuque/0/2022/gif/28072111/1666083449577-5001930d-1511-4351-a8d2-3925262505cf.gif#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=ue0b46dd9&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=20&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uaf8a9242-d99d-443d-a28e-e036d5a5fbb&title=)<br />③在需要事务管理的地方添加seata注解@GlobalTransactional<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/28072111/1666083449752-845a3045-4a25-4bd5-a9c6-89c2536715c5.png#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u36e6667f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=240&originWidth=720&originalType=url&ratio=1&rotation=0&showTitle=false&size=30621&status=done&style=none&taskId=u4d64e30a-d49b-48dc-90b7-dd1a73a1bfb&title=)<br />④在seata-user数据库初始化undo_log表<br />⑤另一个微服务seata-order也按如上操作配置，源码地址：https://gitee.com/yhc910/seata-demo.git<br />⑥启动redis服务、seata-user服务、seata-order服务<br />**四、测试**<br />UserServiceImpl类里，修改如下判断值，验证事务回滚。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/28072111/1666083449972-1ccfc9c0-34eb-4b46-8c53-b5782e759c14.png#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u520d49ce&margin=%5Bobject%20Object%5D&name=image.png&originHeight=144&originWidth=565&originalType=url&ratio=1&rotation=0&showTitle=false&size=12497&status=done&style=none&taskId=u30431f77-504b-4c24-939c-cb402c63c17&title=)<br />**1、数据正常提交**<br />结果：账户余额减少，交易记录正常保存<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/28072111/1666083450639-c230f506-c0f3-4602-8e5b-15d95177f1d2.png#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u3474e9d7&margin=%5Bobject%20Object%5D&name=image.png&originHeight=202&originWidth=1040&originalType=url&ratio=1&rotation=0&showTitle=false&size=65550&status=done&style=none&taskId=uadbabd05-bec2-480d-8721-a582b3891cc&title=)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/28072111/1666083450617-5a3d89e1-8a5b-4164-8254-73571cac3b90.png#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u60261d95&margin=%5Bobject%20Object%5D&name=image.png&originHeight=77&originWidth=981&originalType=url&ratio=1&rotation=0&showTitle=false&size=20239&status=done&style=none&taskId=u68c427ee-3dfc-4a16-93aa-9eb61faad6b&title=)<br />**2、修改判断值为true，抛出异常**<br />结果：账户不动，无交易记录，说明事务已回滚<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/28072111/1666083451176-f7e462f2-b819-4be2-9083-fa3e9fb615a9.png#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u8ab23ec1&margin=%5Bobject%20Object%5D&name=image.png&originHeight=369&originWidth=1941&originalType=url&ratio=1&rotation=0&showTitle=false&size=159898&status=done&style=none&taskId=u8a5b72c8-568b-4121-aad3-c773cfd9f9b&title=)<br />**3、修改判断值为false，重复操作1**<br />结果：发现id有间隔（注意：我们的业务表的主键id是自增），是因为seata是先将数据插入后，事务回滚做的删除，所以该删除数据的id无记录。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/28072111/1666083450881-f85e93d9-fec4-4635-acab-4550cd5d5ad8.png#clientId=u3e5256da-a86d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u2cd80cab&margin=%5Bobject%20Object%5D&name=image.png&originHeight=59&originWidth=963&originalType=url&ratio=1&rotation=0&showTitle=false&size=20804&status=done&style=none&taskId=ude516aba-d394-4662-a507-d28f0a35390&title=)

此次接入有比较多的注意点，这里我列下：<br />1、nacos单机启动命令，需添加 -m standalone 指定模式<br />2、接入seata的配置，tx-service-group的值与vgroup-mapping需保持一致<br />3、A服务调用B服务，B服务获取xid为null，是因为xid没被透传，需自定义Feign的RequestInterceptor处理。<br />String xid = RootContext.getXID();<br />template.header(RootContext.KEY_XID, xid);
